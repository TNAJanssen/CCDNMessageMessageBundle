{% extends param('ccdn_message_message.folder.show.layout_template') %}

{% block stylesheets %}
	{{ parent() }}
{% endblock %}

{% block javascripts %}
	{{ parent() }}
	<script src="{{- asset('bundles/ccdncomponentcommon/js/ccdn/jquery.checkboxes.js') -}}" type="text/javascript"></script>
{% endblock %}

{% block title %}{{- truncDot('title.message.index' |trans({'%folder_name%': current_folder.getName |title }, 'CCDNMessageMessageBundle'), param('ccdn_message_message.seo.title_length')) -}}{% endblock %}

{% block sidebar %}
	{{ parent() }}

	{%- include 'CCDNMessageMessageBundle:Sidebar:sidebar.html.twig' -%}

{% endblock %}

{% block sidebar_status %}
	{{ parent() }}
	{%- spaceless -%}
	
	<div class="well" style="padding: 10px; height: 20px;">
		<span class="pull-left"><i class="icon-hdd"></i>&nbsp;{{- used_allowance -}}&#37;&nbsp;</span>
		<div class="progress progress-danger">
			<div class="bar" style="width:{{- used_allowance -}}%;"></div>
		</div>
	</div>
	
	{%- endspaceless -%}
	
{% endblock %}



{% block body %}

	{%- spaceless -%}

	{%- include 'CCDNComponentCommonBundle:Flashes:flashes.html.twig' -%}

	{%- include 'CCDNComponentCrumbTrailBundle:Trail:trail.html.twig' with {'crumbs': crumbs } -%}

	{#<h2>{{ 'title.message.index' |trans({'%folder_name%': current_folder.getName |title }, 'CCDNMessageMessageBundle') }}</h2>#}

	<div style="display: block; clear: both; overflow: hidden;">

		<form method="POST" action="{{- path('cc_message_action_bulk') -}}" class="form-inline">
			<input type="hidden" id="submit_action" name="submit_action" value="">
			
			<div class="btn-toolbar" style="margin-top:0px;margin-left:30px;" data-compat="interactive-non-js-compat">
				
				<a class="btn btn-large btn-danger" style="width:145px;" href="{{- path('cc_message_message_compose') -}}">{{- 'sidebar.link.compose' | trans({}, 'CCDNMessageMessageBundle') -}}</a>&nbsp;
				
				{%- if current_folder.getName == 'drafts' -%}
					<input type="submit" class="btn btn-primary" value="{{- 'link.message.send_draft' |trans({}, 'CCDNMessageMessageBundle') -}}" name="submit_send">&nbsp;
				{%- endif -%}
				
				<button type="submit" class="btn btn-danger" name="submit_delete"><i class="icon-trash icon-white"></i>&nbsp;{{- 'link.message.delete' |trans({}, 'CCDNMessageMessageBundle') -}}</button>&nbsp;
				
				<input type="submit" class="btn" value="{{- 'link.message.mark_as_read' |trans({}, 'CCDNMessageMessageBundle') -}}" name="submit_mark_as_read">&nbsp;
				
				<input type="submit" class="btn" value="{{- 'link.message.mark_as_unread' |trans({}, 'CCDNMessageMessageBundle') -}}" name="submit_mark_as_unread">&nbsp;
				
				<select name="select_move_to">
					{%- for row, folder in folders -%}
						<option value="{{- folder.getId -}}">{{- folder.getName|title -}}</option>
					{%- endfor -%}
				</select>&nbsp;
				
				<input type="submit" class="btn" value="{{- 'link.message.move_to' |trans({}, 'CCDNMessageMessageBundle') -}}" name="submit_move_to">
			</div>
			
			<div class="btn-toolbar hidden" style="margin-left:30px;" data-compat="interactive-js-compat">

				<a class="btn btn-large btn-danger" style="vertical-align:top;" href="{{- path('cc_message_message_compose') -}}">{{- 'sidebar.link.compose' | trans({}, 'CCDNMessageMessageBundle') -}}</a>&nbsp;
				
				<div class="btn-group">										
					<button class="btn btn-large dropdown-toggle" data-toggle="dropdown"><i class="icon-check"></i>&nbsp;<span class="caret"></span></button>
					<ul class="dropdown-menu">
						<li><a href="#" data-action="select_none" data-identifier="{{- current_folder.name -}}">{{- 'link.message.select_none' |trans({}, 'CCDNMessageMessageBundle') -}}</a></li>
						<li class="divider"></li>
						<li><a href="#" data-action="select_all" data-identifier="{{- current_folder.name -}}" data-qualifier="read">{{- 'link.message.select_all_read' |trans({}, 'CCDNMessageMessageBundle') -}}</a></li>
						<li><a href="#" data-action="select_all" data-identifier="{{- current_folder.name -}}" data-qualifier="unread">{{- 'link.message.select_all_unread' |trans({}, 'CCDNMessageMessageBundle') -}}</a></li>
						<li class="divider"></li>
						<li><a href="#" data-action="select_all" data-identifier="{{- current_folder.name -}}" data-qualifier="draft">{{- 'link.message.select_all_draft' |trans({}, 'CCDNMessageMessageBundle') -}}</a></li>
						<li><a href="#" data-action="select_all" data-identifier="{{- current_folder.name -}}" data-qualifier="flagged">{{- 'link.message.select_all_flagged' |trans({}, 'CCDNMessageMessageBundle') -}}</a></li>
						<li class="divider"></li>
						<li><a href="#" data-action="select_all" data-identifier="{{- current_folder.name -}}" data-qualifier="attached">{{- 'link.message.select_all_attached' |trans({}, 'CCDNMessageMessageBundle') -}}</a></li>
					</ul>
				</div>&nbsp;
				
				<div class="btn-group">
					<button class="btn disabled btn-large dropdown-toggle hidden" disabled data-responds-disabled="{{- current_folder.name -}}" data-responds-hidden="{{- current_folder.name -}}" data-toggle="dropdown"><i class="icon-eye-close"></i>&nbsp;<span class="caret"></span></button>
					<ul class="dropdown-menu">
						<li><a href="#" data-action="submit_mark_as_read">{{- 'link.message.mark_as_read' |trans({}, 'CCDNMessageMessageBundle') -}}</a></li>
						<li><a href="#" data-action="submit_mark_as_unread">{{- 'link.message.mark_as_unread' |trans({}, 'CCDNMessageMessageBundle') -}}</a></li>
					</ul>
				</div>&nbsp;
				
				<div class="btn-group">
					<button class="btn disabled btn-large dropdown-toggle hidden" disabled data-responds-disabled="{{- current_folder.name -}}" data-responds-hidden="{{- current_folder.name -}}" data-toggle="dropdown"><i class="icon-folder-close"></i>&nbsp;<span class="caret"></span></button>
					<ul class="dropdown-menu">
						<li style="padding-left:15px;"><h4>{{- 'link.message.move_to' |trans({}, 'CCDNMessageMessageBundle') -}}</h4></li>
						<li class="divider"></li>
						{%- for row, folder in folders -%}
							<li><a href="#" data-action="submit_move_to" data-value="{{- folder.getId -}}">{{- folder.getName|title -}}</a></li>
						{%- endfor -%}
					</ul>
				</div>&nbsp;
									
				{%- if current_folder.getName == 'drafts' -%}
					<button type="submit" style="vertical-align:top;" disabled data-responds-disabled="{{- current_folder.name -}}" data-responds-hidden="{{- current_folder.name -}}" name="submit_send" class="btn btn-large btn-primary disabled hidden">{{- 'link.message.send_draft' |trans({}, 'CCDNMessageMessageBundle') -}}</button>&nbsp;
				{%- endif -%}						
				
				<button type="submit" style="vertical-align:top;" disabled data-responds-disabled="{{- current_folder.name -}}" data-responds-hidden="{{- current_folder.name -}}" name="submit_delete" class="btn btn-large btn-danger disabled hidden"><i class="icon-trash icon-white"></i>&nbsp;{{- 'link.message.delete' |trans({}, 'CCDNMessageMessageBundle') -}}</button>&nbsp;
				
			</div>

			{%- if pager.haveToPaginate -%}
		    	{{- pagerfanta(pager, 'twitter_bootstrap', {'routeName': 'cc_message_folder_show_paginated', 'routeParams':{'folder_name':current_folder.getName} }) -}}
			{%- endif -%}

			<table class="table">
				<thead>
					<tr>
						<th style="width: 16px;"><input type="checkbox" id="check_all" name="check_all" class="hidden" data-compat='interactive-js-compat' data-action-toggle="{{- current_folder.name -}}" data-identifier="{{- current_folder.name -}}" data-qualifier="all"></th>
						<th style="width: 16px;"><i class="icon-flag"></i></th>
						<th style="width: 16px;"><i class="icon-file"></i></th>
						<th style="width: 16px;"><i class="icon-inbox"></i></th>
						<th style="width: 16px;"><i class="icon-eye-open"></i></th>
						<th style="width: 60px;">{{- ((current_folder.name == 'sent') ? 'message.table.head.to' :'message.table.head.from') | trans({}, 'CCDNMessageMessageBundle') -}}</th>
						<th>{{- 'message.table.head.subject' | trans({}, 'CCDNMessageMessageBundle') -}}</th>
						<th style="width: 140px;">{{- 'message.table.head.sent' | trans({}, 'CCDNMessageMessageBundle') -}}</th>
					</tr>
				</thead>
				<tbody>
				{%- for row, message in messages -%}
					<tr class="{{- (message.isRead ? 'marked_read': 'marked_unread') -}}" data-read="{{- (message.isRead ? 'marked_read': 'marked_unread') -}}" id="message_row_{{- message.id -}}">
						<td>
							<input type="checkbox" id="message_{{- message.id -}}" name="check_message_{{- message.id -}}" data-check-all-responds="true" data-identifier="{{- current_folder.name -}}" data-qualifier="all {{- (message.isRead) ? 'read ' : 'unread ' -}}{{- (message.isDraft) ? 'draft ' : '' -}}{{- (message.isFlagged) ? 'flagged ' : '' -}}{{- (message.attachment) ? 'attached ' : '' -}}">
						</td>
						<td>
							{%- if message.isFlagged -%}
							<i class="icon-flag"></i>
							{%- endif -%}
						</td>
						<td>
							{%- if message.attachment -%}
							<i class="icon-file"></i>
							{%- endif -%}
						</td>
						<td>
							{%- if message.isDraft -%}
								{%- if message.sentFrom -%}
									{%- if message.sentFrom.getId == app.user.id -%}
										<i class="icon-repeat"></i>
									{%- else -%}
										<i class="icon-share-alt"></i>				
									{%- endif -%}
								{%- else -%}
									<i class="icon-pencil"></i>
								{%- endif -%}
							{%- else -%}
								{%- if message.sentFrom -%}
									{%- if message.sentFrom.getId == app.user.id -%}
										<i class="icon-repeat"></i>
									{%- else -%}
										<i class="icon-share-alt"></i>				
									{%- endif -%}
								{%- endif -%}
							{%- endif -%}							
						</td>
						<td>
							{{- (message.isRead) ? '' : '<i class="icon-envelope"></i>' -}}
						</td>
						<td>
							{%- if current_folder.name == "sent" -%}
								{%- if message.getSendTo -%}
									{%- if message.isRead -%}
										{{- truncDot(message.getSendTo |title, 50) -}}
									{%- else -%}
										<b>{{- truncDot(message.getSendTo |title, 50) -}}</b>
									{%- endif -%}
								{%- else -%}
									Guest
								{%- endif -%}
							{%- else -%}
								{%- if message.getSentFrom -%}
									{%- if message.isRead -%}
										<a href="{{- path(user_profile_route, {'user_id': message.getSentFrom.getId}) -}}">{{- message.getSentFrom |title -}}</a>
									{%- else -%}
										<a href="{{- path(user_profile_route, {'user_id': message.getSentFrom.getId}) -}}"><b>{{- message.getSentFrom |title -}}</b></a>
									{%- endif -%}
								{%- else -%}
									Guest
								{%- endif -%}
							{%- endif -%}
						</td>
						<td>
							{%- if message.isRead -%}
								<a href="{{- path('cc_message_message_show_by_id', {'message_id': message.getId }) -}}" title="{{- message.getSubject -}}">{{- truncDot(message.getSubject, param('ccdn_message_message.folder.show.subject_truncate')) -}}</a>
							{%- else -%}
								<a href="{{- path('cc_message_message_show_by_id', {'message_id': message.getId }) -}}" title="{{- message.getSubject -}}"><b>{{- truncDot(message.getSubject, param('ccdn_message_message.folder.show.subject_truncate')) -}}</b></a>
							{%- endif -%}
						</td>
						<td>
							{%- if message.sentTo -%}
								{%- if message.getSentDate -%}
									<abbr class="timestamper" title="{{- message.getSentDate |date('Y-m-d H:i:s T Z', 'Europe/London') -}}">
									{%- if message.isRead -%}
										{{- message.getSentDate |date(param('ccdn_message_message.folder.show.sent_datetime_format')) -}}
									{%- else -%}
										<b>{{- message.getSentDate |date(param('ccdn_message_message.folder.show.sent_datetime_format')) -}}</b>
									{%- endif -%}
									</abbr>
								{%- else -%}

								{%- endif -%}
							{%- endif -%}
						</td>
					</tr>
				{%- else -%}
					<tr>
						<td colspan="8">
							{{- 'message.table.empty' | trans({}, 'CCDNMessageMessageBundle') -}}
						</td>
					</tr>
				{%- endfor -%}
				</tbody>
			</table>
		
			{%- if pager.haveToPaginate -%}
		    	{{- pagerfanta(pager, 'twitter_bootstrap', {'routeName': 'cc_message_folder_show_paginated', 'routeParams':{'folder_name':current_folder.getName} }) -}}
			{%- endif -%}
		
		</form>
	
	</div>

{#	<div class="well">
		<i class="icon-pencil"></i> Draft
		<i class="icon-repeat"></i> Sent to yourself
		<i class="icon-share-alt"></i> Sent Draft
		<i class="icon-flag"></i> Message Flagged as Important
		<i class="icon-file"></i> Attached File
		<i class="icon-envelope"></i> Unread
	</div>#}
	
	{%- include 'CCDNComponentCrumbTrailBundle:Trail:trail.html.twig' with {'crumbs': crumbs } -%}

	<script type='text/javascript'>
	<!--
	$(document).ready(function() {
		
		$("[data-action='submit_mark_as_read']").click(function() {
			$('input#submit_action').attr('value', $(this).attr('data-action'));
			$('input#submit_action').parent('form').submit();
		});
		
		$("[data-action='submit_mark_as_unread']").click(function() {
			$('input#submit_action').attr('value', $(this).attr('data-action'));
			$('input#submit_action').parent('form').submit();
		});
		
		$("[data-action='submit_move_to']").click(function() {
			// set the hidden textbox to action its action type
			$('input#submit_action').attr('value', $(this).attr('data-action'));
			
			// set the select box val to match the data-value of the faux combo box
			$("select[name='select_move_to']").val($(this).attr('data-value'));
			$('input#submit_action').parent('form').submit();
		});
		
		
	});
	//-->
	</script>

	{%- endspaceless -%}

{% endblock %}